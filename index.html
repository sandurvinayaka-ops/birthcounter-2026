<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Live Births | Pulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #010105; 
      color: #f1f5f9;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .mono { font-family: 'JetBrains+Mono', monospace; }
    
    /* Cinematic Deep Space Background - GPU Optimized */
    .space-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
      background: #010108;
      transform: translateZ(0);
    }

    .sun-glow {
      position: absolute;
      top: -10%;
      right: -10%;
      width: 70vw;
      height: 70vw;
      background: radial-gradient(circle, rgba(147, 197, 253, 0.08) 0%, transparent 70%);
      filter: blur(100px);
      pointer-events: none;
      transform: translateZ(0);
    }

    .nebula-layer {
      position: absolute;
      top: -50%; left: -50%; width: 200%; height: 200%;
      background-size: cover;
      background-position: center;
      mix-blend-mode: screen;
      pointer-events: none;
      transform: translateZ(0);
    }

    .nebula-1 {
      background-image: url('https://images.unsplash.com/photo-1464802686167-b939a6910659?q=80&w=2070&auto=format&fit=crop');
      opacity: 0.15;
      filter: blur(6px) hue-rotate(10deg);
      animation: drift-slow 180s linear infinite alternate;
    }

    .nebula-2 {
      background-image: url('https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?q=80&w=2072&auto=format&fit=crop');
      opacity: 0.1;
      filter: blur(15px) saturate(1.5);
      animation: rotate-slow 240s linear infinite;
    }

    .star {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      transform: translateZ(0);
    }
    
    .star-bright {
      box-shadow: 0 0 10px 2px rgba(255,255,255,0.7), 0 0 20px 5px rgba(147, 197, 253, 0.3);
      background-color: #fff !important;
    }

    .twinkle {
      animation: twinkle-pulse var(--duration) ease-in-out infinite alternate;
    }

    @keyframes drift-slow {
      from { transform: translate(-3%, -3%) rotate(0deg) translateZ(0); }
      to { transform: translate(3%, 3%) rotate(2deg) translateZ(0); }
    }

    @keyframes rotate-slow {
      from { transform: rotate(0deg) scale(1.1) translateZ(0); }
      to { transform: rotate(360deg) scale(1) translateZ(0); }
    }

    @keyframes twinkle-pulse {
      0% { opacity: 0.2; transform: scale(0.7) translateZ(0); }
      100% { opacity: 1; transform: scale(1.1) translateZ(0); }
    }

    .comet {
      position: absolute;
      z-index: 10;
      pointer-events: none;
      animation: comet-travel var(--speed) linear forwards;
      transform: rotate(var(--angle)) translateZ(0);
    }

    @keyframes comet-travel {
      0% { transform: translate(var(--start-x), var(--start-y)) rotate(var(--angle)) translateZ(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translate(var(--end-x), var(--end-y)) rotate(var(--angle)) translateZ(0); opacity: 0; }
    }

    .glass-sidebar {
      background: linear-gradient(90deg, rgba(1, 1, 8, 0.8) 0%, rgba(1, 1, 8, 0) 100%);
      border: none;
    }

    .header-spaced {
      letter-spacing: 0.4em;
      font-weight: 900;
      color: #818cf8; 
      text-shadow: 0 0 25px rgba(129, 140, 248, 0.4);
    }

    .amber-bloom {
      color: #fbbf24;
      filter: drop-shadow(0 0 40px rgba(251, 191, 36, 0.6));
      text-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
    }

    .progress-track {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #fbbf24);
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
      transition: width 1s linear;
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "d3": "https://esm.sh/d3@^7.9.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    const BIRTHS_PER_SECOND = 4.35;
    const FLASH_BURST_COLOR = "#FFFFFF"; 
    const FLASH_BLOOM_COLOR = "#fbbf24"; 
    const LAND_COLOR = "#33333a"; 
    const ICE_COLOR = "#f8fafc";  
    const ROTATION_SPEED = 0.5; 
    const ATMOSPHERE_PADDING = 60; // Extra padding for large TV screens to prevent clipping
    
    const COUNTRIES_WEIGHTS = [
      { id: 'IND', weight: 24.2 }, { id: 'CHN', weight: 9.4 },
      { id: 'NGA', weight: 8.0 }, { id: 'PAK', weight: 6.4 },
      { id: 'IDN', weight: 4.5 }, { id: 'USA', weight: 3.6 },
      { id: 'ETH', weight: 3.9 }, { id: 'BRA', weight: 2.7 },
      { id: 'BGD', weight: 3.0 }, { id: 'COD', weight: 4.1 },
      { id: 'RUS', weight: 1.4 }, { id: 'MEX', weight: 2.0 },
      { id: 'PHL', weight: 2.0 }, { id: 'EGY', weight: 2.6 },
      { id: 'VNM', weight: 1.5 }, { id: 'TUR', weight: 1.2 },
      { id: 'DEU', weight: 0.8 }, { id: 'GBR', weight: 0.7 },
      { id: 'FRA', weight: 0.7 }, { id: 'ZAF', weight: 1.2 },
      { id: 'OTHER', weight: 12.0 }
    ];

    const STELLAR_COLORS = ['#9bb0ff', '#aabfff', '#cad7ff', '#f8f7ff', '#fff4ea', '#ffd2a1', '#ffcc6f'];

    const StarBackground = () => {
      const starLayers = useMemo(() => {
        return [
          Array.from({ length: 150 }).map((_, i) => ({
            id: `l1-${i}`, top: `${Math.random() * 100}%`, left: `${Math.random() * 100}%`,
            size: 1.5, duration: `${Math.random() * 4 + 3}s`, delay: `${Math.random() * 10}s`,
            color: STELLAR_COLORS[Math.floor(Math.random() * 3)], layer: 1
          })),
          Array.from({ length: 100 }).map((_, i) => ({
            id: `l2-${i}`, top: `${Math.random() * 100}%`, left: `${Math.random() * 100}%`,
            size: Math.random() * 3 + 1, duration: `${Math.random() * 3 + 1}s`, delay: `${Math.random() * 5}s`,
            color: STELLAR_COLORS[Math.floor(Math.random() * STELLAR_COLORS.length)], layer: 2, isBright: Math.random() > 0.85
          }))
        ];
      }, []);

      const [comets, setComets] = useState([]);

      useEffect(() => {
        const spawnComet = () => {
          const id = Date.now();
          const speed = Math.random() * 5 + 3; 
          const startXVal = Math.random() * 100;
          const startYVal = Math.random() * 100;
          const angle = Math.atan2(50 - startYVal, 50 - startXVal) * (180 / Math.PI);
          setComets(prev => [...prev, { id, startX: startXVal+'vw', startY: startYVal+'vh', angle: angle+'deg', speed: speed+'s' }]);
          setTimeout(() => setComets(prev => prev.filter(c => c.id !== id)), speed * 1000 + 100);
          setTimeout(spawnComet, 5000 + Math.random() * 10000);
        };
        setTimeout(spawnComet, 2000);
      }, []);

      return (
        <div className="space-background">
          <div className="sun-glow"></div>
          <div className="nebula-layer nebula-1"></div>
          <div className="nebula-layer nebula-2"></div>
          {starLayers.flat().map(star => (
            <div key={star.id} className={`star twinkle ${star.isBright ? 'star-bright' : ''}`} style={{
                top: star.top, left: star.left, width: `${star.size}px`, height: `${star.size}px`, backgroundColor: star.color, '--duration': star.duration, animationDelay: star.delay, opacity: star.layer === 1 ? 0.3 : 0.7
              }}
            />
          ))}
          {comets.map(c => (
            <div key={c.id} className="comet" style={{ left: c.startX, top: c.startY, '--angle': c.angle, '--speed': c.speed }}>
              <div style={{ width: '8px', height: '8px', background: '#fff', borderRadius: '50%', boxShadow: '0 0 20px #fbbf24' }}></div>
            </div>
          ))}
        </div>
      );
    };

    const WorldMap = ({ lastBirth }) => {
      const canvasRef = useRef(null);
      const [geoData, setGeoData] = useState(null);
      const rotationRef = useRef([0, -12]); 
      const activeFlashesRef = useRef(new Map()); 
      const animationFrameRef = useRef(null);

      useEffect(() => {
        fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson')
          .then(res => res.json())
          .then(data => setGeoData(data));
      }, []);

      useEffect(() => {
        if (!geoData || !canvasRef.current) return;

        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');
        if (!context) return;
        
        const dpr = window.devicePixelRatio || 1;

        const updateSize = () => {
          const container = canvas.parentElement;
          if (!container) return;
          canvas.width = container.clientWidth * dpr;
          canvas.height = container.clientHeight * dpr;
          canvas.style.width = `${container.clientWidth}px`;
          canvas.style.height = `${container.clientHeight}px`;
          context.setTransform(1, 0, 0, 1, 0, 0); 
          context.scale(dpr, dpr);
        };
        updateSize();

        const render = () => {
          const width = canvas.width / dpr;
          const height = canvas.height / dpr;
          if (width <= 0 || height <= 0) {
            animationFrameRef.current = requestAnimationFrame(render);
            return;
          }
          
          // Maximize globe size for TV viewing while fitting inside container
          const globeRadius = Math.max(10, (Math.min(width, height) / 2) - ATMOSPHERE_PADDING);

          const projection = d3.geoOrthographic()
            .scale(globeRadius)
            .translate([width / 2, height / 2])
            .clipAngle(90);

          const path = d3.geoPath(projection, context);

          context.clearRect(0, 0, width, height);
          rotationRef.current[0] += ROTATION_SPEED;
          projection.rotate(rotationRef.current);

          // 1. Atmosphere Glow
          const r1 = Math.max(0.1, globeRadius - 5);
          const r2 = globeRadius + 50;
          const atmosphereGrad = context.createRadialGradient(width/2, height/2, r1, width/2, height/2, r2);
          atmosphereGrad.addColorStop(0, 'rgba(147, 197, 253, 0.4)');
          atmosphereGrad.addColorStop(1, 'rgba(147, 197, 253, 0)');
          context.fillStyle = atmosphereGrad;
          context.beginPath();
          context.arc(width/2, height/2, r2, 0, 2*Math.PI);
          context.fill();

          // 2. Ocean
          context.beginPath();
          context.arc(width/2, height/2, globeRadius, 0, 2*Math.PI);
          const oceanGrad = context.createRadialGradient(width/2 * 1.2, height/2 * 0.8, Math.max(0.1, globeRadius*0.2), width/2, height/2, globeRadius);
          oceanGrad.addColorStop(0, '#0066cc');
          oceanGrad.addColorStop(1, '#002b4d');
          context.fillStyle = oceanGrad;
          context.fill();

          // 3. Land
          const now = Date.now();
          if (geoData && geoData.features) {
            geoData.features.forEach(feature => {
              const centroid = d3.geoCentroid(feature);
              const visible = d3.geoDistance(centroid, [-rotationRef.current[0], -rotationRef.current[1]]) < Math.PI / 2.1;
              
              if (visible) {
                context.beginPath();
                path(feature);
                
                const flash = activeFlashesRef.current.get(feature.id);
                if (flash) {
                  const age = now - flash.startTime;
                  if (age > 2000) {
                    activeFlashesRef.current.delete(feature.id);
                    context.fillStyle = (feature.id === 'ATA' || feature.id === 'GRL') ? ICE_COLOR : LAND_COLOR;
                    context.shadowBlur = 0;
                  } else {
                    const t = age / 2000;
                    context.fillStyle = age < 100 ? FLASH_BURST_COLOR : d3.interpolateRgb(FLASH_BLOOM_COLOR, LAND_COLOR)(t);
                    context.shadowBlur = 25 * (1 - t);
                    context.shadowColor = FLASH_BLOOM_COLOR;
                  }
                } else {
                  context.fillStyle = (feature.id === 'ATA' || feature.id === 'GRL') ? ICE_COLOR : LAND_COLOR;
                  context.shadowBlur = 0;
                }
                
                context.fill();
                context.strokeStyle = 'rgba(255,255,255,0.15)';
                context.lineWidth = 0.5;
                context.stroke();
              }
            });
          }

          // 4. Shade
          const shadowGrad = context.createRadialGradient(width/2 * 0.6, height/2 * 0.6, Math.max(0.1, globeRadius*0.3), width/2, height/2, globeRadius);
          shadowGrad.addColorStop(0, 'rgba(255,255,255,0.08)');
          shadowGrad.addColorStop(1, 'rgba(0,0,0,0.5)');
          context.fillStyle = shadowGrad;
          context.beginPath();
          context.arc(width/2, height/2, globeRadius, 0, 2*Math.PI);
          context.fill();

          // 5. Glare
          const specular = context.createRadialGradient(width/2 * 0.7, height/2 * 0.7, 0, width/2, height/2, globeRadius);
          specular.addColorStop(0, 'rgba(255,255,255,0.2)');
          specular.addColorStop(1, 'transparent');
          context.fillStyle = specular;
          context.fill();

          animationFrameRef.current = requestAnimationFrame(render);
        };

        animationFrameRef.current = requestAnimationFrame(render);
        window.addEventListener('resize', updateSize);
        return () => {
          if (animationFrameRef.current) cancelAnimationFrame(animationFrameRef.current);
          window.removeEventListener('resize', updateSize);
        };
      }, [geoData]);

      useEffect(() => {
        if (!lastBirth || !geoData) return;
        let targetId = lastBirth.countryId;
        if (targetId === "OTHER") {
          const others = geoData.features.filter(f => f.id !== 'ATA' && !COUNTRIES_WEIGHTS.some(c => c.id === f.id));
          if (others.length > 0) targetId = others[Math.floor(Math.random() * others.length)].id;
        }
        activeFlashesRef.current.set(targetId, { startTime: Date.now() });
      }, [lastBirth]);

      return (
        <div className="relative w-full h-full flex items-center justify-center overflow-hidden">
          <canvas ref={canvasRef} className="block" />
        </div>
      );
    };

    const App = () => {
      const [totalToday, setTotalToday] = useState(0);
      const [lastBirth, setLastBirth] = useState(null);
      const [dayProgress, setDayProgress] = useState(0);
      const [currentTime, setCurrentTime] = useState('');
      const totalTodayRef = useRef(0);

      useEffect(() => {
        const updateProgress = () => {
          const now = new Date();
          const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const secondsElapsed = (now.getTime() - startOfDay.getTime()) / 1000;
          setDayProgress((secondsElapsed / 86400) * 100);
          setCurrentTime(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }));
        };

        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const initialCount = Math.floor(((now.getTime() - startOfDay.getTime()) / 1000) * BIRTHS_PER_SECOND);
        setTotalToday(initialCount);
        totalTodayRef.current = initialCount;

        const interval = setInterval(updateProgress, 1000);

        const schedule = () => {
          const delay = -Math.log(Math.random()) * (1000 / BIRTHS_PER_SECOND);
          setTimeout(() => {
            const totalWeight = COUNTRIES_WEIGHTS.reduce((acc, c) => acc + c.weight, 0);
            let r = Math.random() * totalWeight;
            let selectedId = "OTHER";
            for (const c of COUNTRIES_WEIGHTS) {
              if (r < c.weight) { selectedId = c.id; break; }
              r -= c.weight;
            }
            totalTodayRef.current += 1;
            setTotalToday(totalTodayRef.current);
            setLastBirth({ countryId: selectedId, timestamp: Date.now() });
            schedule();
          }, delay);
        };
        schedule();
        return () => clearInterval(interval);
      }, []);

      return (
        <div className="h-screen w-screen flex flex-col bg-transparent overflow-hidden">
          <StarBackground />
          <div className="flex-1 flex overflow-hidden">
            <div className="w-[30%] flex flex-col justify-center items-center p-16 relative glass-sidebar z-20">
              <div className="w-full max-w-xl text-left">
                <div className="header-spaced text-3xl uppercase mb-8 leading-tight font-black opacity-60">
                  Global<br/>Live Births
                </div>
                <div className="text-[8vw] font-black amber-bloom mono leading-none tracking-tighter whitespace-nowrap mb-12">
                  {new Intl.NumberFormat('de-DE').format(totalToday)}
                </div>
                <div className="w-[100%] mt-4 text-left relative">
                   <div className="h-8 relative w-full mb-2">
                      <div className="absolute bottom-0 text-[14px] font-black text-white/80 mono whitespace-nowrap transition-all duration-1000 linear" style={{ left: `${dayProgress}%`, transform: 'translateX(-50%)' }}>
                        {currentTime}
                      </div>
                   </div>
                   <div className="progress-track">
                     <div className="progress-fill" style={{ width: `${dayProgress}%` }}></div>
                   </div>
                   <div className="mt-4 flex justify-between text-[11px] font-bold text-slate-500 uppercase tracking-widest">
                     <span>Today's Cycle</span>
                     <span>{Math.floor(dayProgress)}% Complete</span>
                   </div>
                </div>
              </div>
            </div>
            <div className="flex-1 relative z-10 flex items-center justify-center p-0">
               <WorldMap lastBirth={lastBirth} />
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>